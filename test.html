<!DOCTYPE html>

<meta charset="utf-8">

<script src="test.js"></script>
<script src="a.out.js"></script>

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v6.js"></script>

<div id="main">

<div id="left-bar">

<label for="load_wasm">Upload a file:</label>
<input type="file" id="load_wasm">

<br><br>

<button onclick="myFunction()">Delete a random node and an edge</button>
</div>

<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>

</div>

<style>
  #main {
    display: flex;
    flex-direction: row;
  }

  #left-bar {
    width: 200px;
    height: 800px;
    background-color: #f0f0f0;
    padding: 20px;
    margin-right: 20px;
  }

  #my_dataviz {
    font: 10px sans-serif;
    text-align: center;
    margin: auto;
    border: 1px solid #ccc;
    width: 800px;
    height: 800px;
  }
</style>

<script>

// set the dimensions and margins of the graph
const margin = {top: 10, right: 30, bottom: 30, left: 40},
  width = 800 - margin.left - margin.right,
      height = 800 - margin.top - margin.bottom;

  var link, node;
  var links, nodes;

// append the svg object to the body of the page
const svg = d3.select("#my_dataviz")
.append("svg")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
.append("g")
  .attr("transform",
        `translate(${margin.left}, ${margin.top})`);

d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/data_network.json").then( function( data) {

  links = data.links;
  nodes = data.nodes;

  // Initialize the links
  link = svg
    .selectAll("line")
    .data(data.links)
    .join("line")
      .style("stroke", "#aaa")

  // Initialize the nodes
  node = svg
    .selectAll("circle")
    .data(data.nodes)
    .join("circle")
      .attr("r", 20)
      .style("fill", "#69b3a2")

  // Let's list the force we wanna apply on the network
  const simulation = d3.forceSimulation(data.nodes)                 // Force algorithm is applied to data.nodes
      .force("link", d3.forceLink()                               // This force provides links between nodes
            .id(function(d) { return d.id; })                     // This provide  the id of a node
            .links(data.links)                                    // and this the list of links
      )
      .force("charge", d3.forceManyBody().strength(-400))         // This adds repulsion between nodes. Play with the -400 for the repulsion strength
      .force("center", d3.forceCenter(width / 2, height / 2))     // This force attracts nodes to the center of the svg area
      .on("tick", ticked);

  // This function is run at each iteration of the force algorithm, updating the nodes position.
  function ticked() {
    link
        .attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    node
         .attr("cx", function (d) { return d.x+6; })
         .attr("cy", function(d) { return d.y-6; });
  }

// Add a drag behavior.
  node.call(d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended));

  // Reheat the simulation when drag starts, and fix the subject position.
console.log(data.links);

  function dragstarted(event) {
    if (!event.active) simulation.alphaTarget(0.3).restart();
    event.subject.fx = event.subject.x;
    event.subject.fy = event.subject.y;
  }

  // Update the subject (dragged node) position during drag.
  function dragged(event) {
    event.subject.fx = event.x;
    event.subject.fy = event.y;
}

  // Restore the target alpha so the simulation cools after dragging ends.
  // Unfix the subject position now that itâ€™s no longer being dragged.
  function dragended(event) {
    if (!event.active) simulation.alphaTarget(0);
    event.subject.fx = null;
    event.subject.fy = null;
  }
});

function myFunction(){
  links.splice(0, 1);
  nodes.splice(0, 1);

  link = svg
    .selectAll("line")
    .data(links)
    .join("line")
      .style("stroke", "#aaa")

  // Initialize the nodes
  node = svg
    .selectAll("circle")
    .data(nodes)
    .join("circle")
      .attr("r", 20)
      .style("fill", "#69b3a2")
}
</script>

<script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('load_wasm');
            let wasmExports = null; // To store the WASM exports once loaded

            fileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) {
                    console.log("No file selected.");
                    return;
                }

                if (file.name.split('.').pop().toLowerCase() !== 'wasm') {
                    alert("Please upload a .wasm file.");
                    fileInput.value = ''; // Clear the input
                    return;
                }

                console.log(`Selected file: ${file.name}`);

                try {
                    // Read the file as an ArrayBuffer
                    const arrayBuffer = await file.arrayBuffer();
                    console.log("File read as ArrayBuffer.");
                    console.log(arrayBuffer);

                    
              importObject={
                env: {
                  jsLog: (ptr, len) => {
                    const msg = decodeStr(ptr, len);
                    document.querySelector("#log").textContent = msg;
                    console.log(msg);
                  }, }
                //env: {}
                //env: {
                //  STACKTOP: 0,
                //  STACK_MAX:65536,
                //  abortStackOverflow: function(val) { throw new Error("stackoverfow"); },
                //  memory: new WebAssembly.Memory( { initial: 256, maximum:256 } ),
                //  table: new WebAssembly.Table( { initial:0, maximum:0, element: "anyfunc" } ),
                //  __linear_memory: new WebAssembly.Memory({initial: 256}),
                //  __stack_pointer: 0,
                //  memoryBase:0,
                //  tableBase:0
                //}
              }
                    // Instantiate the WebAssembly module from the ArrayBuffer
                    const { instance } = await WebAssembly.instantiate(arrayBuffer, importObject);

                    wasmExports = instance.exports;
                    console.log("WASM module loaded successfully!");

                    console.log("WASM exports:", wasmExports);

                    // Example: Assuming your add.wasm has an 'add' function
                    if (wasmExports.add) {
                        console.log(`Result of add(4, 1): ${wasmExports.add(4, 1)}`);
                    } else {
                        console.warn("The loaded WASM module does not have an 'add' function.");
                    }

                } catch (error) {
                    console.error("Error loading WASM file:", error);
                    alert("Failed to load WASM file. Check console for details.");
                }
            });

            // The original init function (modified to be called on file selection)
            // async function init() {
            //     // This function is now superseded by the file input's change event listener
            //     // where the WASM is loaded from the selected file.
            //     // If you still need a default WASM to load on page load, you can keep a modified version here.
            // }

            // You can optionally call the init function if you want to load a default WASM on page load
            // For example, if you have a default `add.wasm` in the same directory:
            /*
            async function loadDefaultWASM() {
                try {
                    const { instance } = await WebAssembly.instantiateStreaming(
                        fetch("./add.wasm")
                    );
                    wasmExports = instance.exports;
                    console.log("Default WASM loaded successfully!");
                    if (wasmExports.add) {
                        console.log(`Result of default add(4, 1): ${wasmExports.add(4, 1)}`);
                    }
                } catch (error) {
                    console.warn("Could not load default WASM (add.wasm). Please select a file.", error);
                }
            }
            loadDefaultWASM();
            */
        });
</script>
